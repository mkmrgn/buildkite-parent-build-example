agents:
  queue: demo

steps:
  - label: "Generate an artifact :artist:"
    key: "generate-artifact"
    command: "echo 'This is an artifact generated by the parent build!' > parent-artifact.txt"
    artifact_paths:
      - "parent-artifact.txt"
      
  - label: "Trigger a build for the child pipeline :arrow_right:"
    key: "child-build"
    trigger: "trigger-example-child-pipeline"
    depends_on: "generate-artifact"
    build:
      env:
        TRIGGER_JOB_ID: $BUILDKITE_JOB_ID
  
  - label: "Fetch child-build artifact"
    key: "fetch-artifact"
    depends_on: "child-build"
    command: "buildkite-agent artifact download child-artifact.txt . --build $(buildkite-agent meta-data get 'triggered_build_id')"
    artifact_paths:
      - "child-artifact.txt"
      
  - label: "Annotating build :pencil2:"
    depends_on: "fetch-artifact"
    commands:
      - "buildkite-agent artifact download child-artifact.txt ."
      - "buildkite-agent annotate --style 'info' 'The following annotation is generated from the artifact download from the child build'"
      - "cat child-artifact.txt | buildkite-agent annotate --style 'success'"
